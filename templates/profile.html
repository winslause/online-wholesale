<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - Wholesale Management</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Wholesale Management</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('home') }}">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#cartModal">My Cart</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#ordersModal">My Orders</a></li>
        <li class="nav-item active"><a class="nav-link" href="{{ url_for('profile') }}">Profile</a></li>
        <li class="nav-item active"><a href="{{ url_for('update_profile') }}" class="nav-link">Update Profile</a></li>
        <li class="nav-item">
          <form action="{{ url_for('logout') }}" method="post">
            <button type="submit" class="btn btn-link nav-link">Logout</button>
          </form>
        </li>
        <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#adminLoginModal">Admin</a></li>
      </ul>
      <form class="form-inline my-2 my-lg-0" action="{{ url_for('search') }}" method="GET">
        <input class="form-control mr-sm-2" type="search" placeholder="Search products" name="query">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
    </div>
  </nav>

  <!-- Flash Messages -->
  <div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Profile Content -->
  <div class="container profile-header">
    <h1>Welcome, {{ current_user.company_name }}</h1>
    <h2>Your Cart</h2>
    {% if cart_items %}
      <table class="cart-table">
        <thead>
          <tr>
            <th>Image</th>
            <th>Product</th>
            <th>Description</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for cart_item in cart_items %}
            <tr data-product-id="{{ cart_item.product_id }}">
              <td><img src="{{ url_for('static', filename='uploads/' + cart_item.product.images.split(',')[0]) }}" alt="{{ cart_item.product.name }}"></td>
              <td>{{ cart_item.product.name }}</td>
              <td>{{ cart_item.product.description | truncate(100) }}</td>
              <td>KES {{ cart_item.product.price }}</td>
              <td>
                <div class="quantity-control">
                  <button class="btn-minus" data-product-id="{{ cart_item.product_id }}">-</button>
                  <input type="number" class="quantity-input" value="{{ cart_item.quantity }}" min="1" max="{{ cart_item.product.quantity }}" data-product-id="{{ cart_item.product_id }}">
                  <button class="btn-plus" data-product-id="{{ cart_item.product_id }}">+</button>
                </div>
              </td>
              <td class="item-total">KES {{ cart_item.product.price * cart_item.quantity }}</td>
              <td>
                <form action="{{ url_for('remove_from_cart', product_id=cart_item.product_id) }}" method="post">
                  <button type="submit" class="btn-delete">Remove</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="total-price">Total Price: KES <span id="total-price">{{ cart_total }}</span></div>
      <button class="btn-checkout" data-toggle="modal" data-target="#checkoutModal">Proceed to Checkout</button>
    {% else %}
      <p>Your cart is empty.</p>
    {% endif %}

    <div class="orders-section">
      <h2>Your Orders</h2>
      {% if orders %}
        {% for order in orders %}
          <div class="order-item">
            <p><strong>Product:</strong> {{ order.product.name }}</p>
            <p><strong>Quantity:</strong> {{ order.quantity }}</p>
            <p><strong>Total Price:</strong> KES {{ order.total_price }}</p>
            <p><strong>Ordered At:</strong> {{ order.ordered_at }}</p>
            <p><strong>Status:</strong> {{ order.status | capitalize }}</p>
            {% if order.status == 'pending' %}
              <form action="{{ url_for('cancel_order', order_id=order.id) }}" method="post">
                <button type="submit" class="btn-cancel-order">Cancel Order</button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p>You have no orders.</p>
      {% endif %}
    </div>
  </div>

  <!-- Checkout Modal (Reused from home.html) -->
  <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          {% if current_user.is_authenticated %}
            <div class="alert-section">
              <p><strong>Please send KES {{ cart_total }} to M-Pesa number 0712345678</strong></p>
              <p><strong>Enter the transaction code below:</strong></p>
            </div>
            <ul class="list-unstyled">
              {% for cart_item in cart_items %}
                {% set item_total = cart_item.product.price * cart_item.quantity %}
                <li class="mb-3 p-3 bg-dark rounded">
                  <h6>{{ cart_item.product.name }}</h6>
                  <p>Description: {{ cart_item.product.description }}</p>
                  <p>Price: KES {{ cart_item.product.price }}</p>
                  <p>Quantity: {{ cart_item.quantity }}</p>
                  <p>Item Total: KES {{ item_total }}</p>
                </li>
              {% endfor %}
            </ul>
            <p class="total-amount">Total Amount: KES {{ cart_total }}</p>
            <form action="{{ url_for('checkout') }}" method="POST" id="checkoutForm">
              <div class="form-group">
                <label for="transaction-code">Transaction Code:</label>
                <input type="text" class="form-control" id="transaction-code" name="transaction-code" placeholder="Enter transaction code" required>
              </div>
              <button type="submit" class="btn-checkout">Checkout</button>
            </form>
          {% else %}
            <p>Please log in to proceed with checkout.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal (Reused from home.html) -->
  <div class="modal fade" id="adminLoginModal" tabindex="-1" aria-labelledby="adminLoginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adminLoginModalLabel">Admin Login</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('admin_login') }}" method="POST" id="adminLoginForm">
            <div class="form-group">
              <label for="admin_username">Username</label>
              <input type="text" class="form-control" id="admin_username" name="admin_username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
              <label for="admin_password">Password</label>
              <input type="password" class="form-control" id="admin_password" name="admin_password" placeholder="Enter password" required>
            </div>
            <button type="submit" class="btn btn-success btn-block">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    $(document).ready(function() {
      // Debug modal triggers
      $('[data-toggle="modal"]').on('click', function(e) {
        e.preventDefault();
        var target = $(this).data('target');
        console.log('Modal trigger clicked: ' + target);
        $(target).modal('show');
      });

      // Debug modal events
      $('.modal').on('show.bs.modal', function() {
        console.log('Modal opened: #' + $(this).attr('id'));
      }).on('hide.bs.modal', function() {
        console.log('Modal closed: #' + $(this).attr('id'));
        $('#checkoutForm input, #adminLoginForm input').each(function() {
          console.log('Input state on modal hide:', {
            id: $(this).attr('id'),
            value: $(this).attr('type') === 'password' ? '[HIDDEN]' : $(this).val()
          });
        });
      });

      // Update total price
      function updateTotalPrice() {
        let total = 0;
        $('.cart-table tbody tr').each(function() {
          const itemTotal = parseFloat($(this).find('.item-total').text().replace('KES ', ''));
          total += itemTotal;
        });
        $('#total-price').text(total.toFixed(2));
        console.log('Total price updated:', total);
      }

      // Quantity plus/minus buttons
      $('.btn-plus').on('click', function() {
        const productId = $(this).data('product-id');
        const input = $(this).closest('.quantity-control').find('.quantity-input');
        const newQuantity = parseInt(input.val()) + 1;
        const maxQuantity = parseInt(input.attr('max'));
        if (newQuantity <= maxQuantity) {
          input.val(newQuantity);
          updateCartQuantity(productId, newQuantity, input);
          console.log('Plus button clicked:', { productId, newQuantity });
        } else {
          alert('Cannot exceed available quantity.');
        }
      });

      $('.btn-minus').on('click', function() {
        const productId = $(this).data('product-id');
        const input = $(this).closest('.quantity-control').find('.quantity-input');
        const newQuantity = parseInt(input.val()) - 1;
        if (newQuantity >= 1) {
          input.val(newQuantity);
          updateCartQuantity(productId, newQuantity, input);
          console.log('Minus button clicked:', { productId, newQuantity });
        }
      });

      // Manual quantity input
      $('.quantity-input').on('change', function() {
        const productId = $(this).data('product-id');
        let newQuantity = parseInt($(this).val());
        const maxQuantity = parseInt($(this).attr('max'));
        if (newQuantity < 1) {
          newQuantity = 1;
          $(this).val(1);
        } else if (newQuantity > maxQuantity) {
          newQuantity = maxQuantity;
          $(this).val(maxQuantity);
          alert('Cannot exceed available quantity.');
        }
        updateCartQuantity(productId, newQuantity, $(this));
        console.log('Quantity input changed:', { productId, newQuantity });
      });

      // Update cart quantity via AJAX
      function updateCartQuantity(productId, newQuantity, inputElement) {
        $.ajax({
          url: '{{ url_for("update_cart_quantity") }}',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ product_id: productId, new_quantity: newQuantity }),
          success: function(response) {
            if (response.success) {
              const price = parseFloat(inputElement.closest('tr').find('td:eq(3)').text().replace('KES ', ''));
              const itemTotal = price * newQuantity;
              inputElement.closest('tr').find('.item-total').text('KES ' + itemTotal.toFixed(2));
              updateTotalPrice();
              console.log('Cart quantity updated:', { productId, newQuantity, itemTotal });
            } else {
              alert('Failed to update quantity: ' + response.message);
              console.error('Update cart quantity failed:', response.message);
            }
          },
          error: function(xhr, status, error) {
            console.error('AJAX error updating quantity:', status, error);
            alert('Error updating quantity. Please try again.');
          }
        });
      }

      // Debug checkout form submission
      $('#checkoutForm').on('submit', function() {
        const transactionCode = $('#transaction-code').val();
        console.log('Checkout form submitted:', { transactionCode });
      });

      // Debug cancel order submission
      $('.btn-cancel-order').on('click', function() {
        const form = $(this).closest('form');
        console.log('Cancel order clicked:', { action: form.attr('action') });
      });
    });
  </script>
</body>
</html>
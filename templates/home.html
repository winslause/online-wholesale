<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wholesale Management</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <style>
    .validation-message {
      font-size: 0.9em;
      margin-top: 5px;
    }
    .validation-error {
      color: #dc3545;
    }
    .validation-success {
      color: #28a745;
    }
    .password-checklist {
      list-style: none;
      padding: 0;
      margin: 5px 0 0 0;
    }
    .password-checklist li {
      font-size: 0.85em;
      margin-bottom: 3px;
    }
    .password-checklist li.valid {
      color: #28a745;
    }
    .password-checklist li.invalid {
      color: #dc3545;
    }
    /* New styles for eye icon inside input */
    .password-input-wrapper {
      position: relative;
    }
    .password-input-wrapper input {
      padding-right: 40px; /* Space for the eye icon */
    }
    .password-input-wrapper .toggle-icon {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      cursor: pointer;
      color: #6c757d; /* Bootstrap secondary color */
      font-size: 1rem;
    }
    .password-input-wrapper .toggle-icon:hover {
      color: #495057;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Wholesale Management</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active"><a class="nav-link" href="{{ url_for('home') }}">Home</a></li>
        {% if current_user.is_authenticated %}
          <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#cartModal">My Cart</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#ordersModal">My Orders</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('profile') }}">Profile</a></li>
          <li class="nav-item">
            <form action="{{ url_for('logout') }}" method="post">
              <button type="submit" class="btn btn-link nav-link">Logout</button>
            </form>
          </li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#loginModal">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#registerModal">Register</a></li>
        {% endif %}
        <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#adminLoginModal">Admin</a></li>
      </ul>
      <form class="form-inline my-2 my-lg-0" action="{{ url_for('search') }}" method="GET">
        <input class="form-control mr-sm-2" type="search" placeholder="Search products" name="query">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
    </div>
  </nav>

  <!-- Flash Messages -->
  <div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Main Content with Sidebar -->
  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 sidebar" id="sidebar">
        <button class="btn btn-primary btn-sm d-md-none mb-3" type="button" id="sidebarToggle">
          <i class="fas fa-bars"></i> Filters
        </button>
        <div class="sidebar-content" id="sidebarContent">
          <h5 class="sidebar-title">Filters</h5>
          <!-- Categories -->
          <div class="mb-3">
            <h6>Categories</h6>
            <ul class="list-unstyled">
              <li><a href="{{ url_for('home') }}" class="category-link {{ '' if not selected_category else 'text-muted' }}">All Categories</a></li>
              {% for category in categories %}
                <li><a href="{{ url_for('search', category_id=category.id) }}" class="category-link {{ 'active' if selected_category == category.id else '' }}">{{ category.name }}</a></li>
              {% endfor %}
            </ul>
          </div>
          <!-- Sort by Price -->
          <div class="mb-3">
            <h6>Sort by Price</h6>
            <form action="{{ url_for('search') }}" method="GET" id="sortForm">
              <select name="sort" class="form-control form-control-sm" onchange="this.form.submit()">
                <option value="">Select</option>
                <option value="price_asc" {{ 'selected' if sort == 'price_asc' else '' }}>Price: Low to High</option>
                <option value="price_desc" {{ 'selected' if sort == 'price_desc' else '' }}>Price: High to Low</option>
              </select>
              {% if selected_category %}
                <input type="hidden" name="category_id" value="{{ selected_category }}">
              {% endif %}
              {% if query %}
                <input type="hidden" name="query" value="{{ query }}">
              {% endif %}
              {% if min_price %}
                <input type="hidden" name="min_price" value="{{ min_price }}">
              {% endif %}
              {% if max_price %}
                <input type="hidden" name="max_price" value="{{ max_price }}">
              {% endif %}
            </form>
          </div>
          <!-- Price Range -->
          <div class="mb-3">
            <h6>Price Range (KES)</h6>
            <form action="{{ url_for('search') }}" method="GET" id="priceRangeForm">
              <div class="form-group">
                <label for="minPrice">Min</label>
                <input type="number" class="form-control form-control-sm" id="minPrice" name="min_price" value="{{ min_price or '' }}" min="0" placeholder="0">
              </div>
              <div class="form-group">
                <label for="maxPrice">Max</label>
                <input type="number" class="form-control form-control-sm" id="maxPrice" name="max_price" value="{{ max_price or '' }}" min="0" placeholder="10000">
              </div>
              <button type="submit" class="btn btn-primary btn-sm btn-block">Apply</button>
              {% if selected_category %}
                <input type="hidden" name="category_id" value="{{ selected_category }}">
              {% endif %}
              {% if sort %}
                <input type="hidden" name="sort" value="{{ sort }}">
              {% endif %}
              {% if query %}
                <input type="hidden" name="query" value="{{ query }}">
              {% endif %}
            </form>
          </div>
        </div>
      </div>
      <!-- Product Display -->
      <div class="col-md-9 col-lg-10">
        <div class="row g-2">
          {% if products %}
            {% for product in products %}
              {% if product.quantity > 0 %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                  <div class="card h-100">
                    <a href="#" class="product-link" data-toggle="modal" data-target="#productDetailsModal"
                       data-id="{{ product.id }}"
                       data-name="{{ product.name }}"
                       data-description="{{ product.description }}"
                       data-price="{{ product.price }}"
                       data-quantity="{{ product.quantity }}"
                       data-images="{{ product.images }}">
                      <img src="{{ url_for('static', filename='uploads/' + product.images.split(',')[0]) }}" alt="{{ product.name }}" class="card-img-top">
                      <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">Price: KES {{ product.price }}</p>
                        <p class="card-text">Available: {{ product.quantity }}</p>
                      </div>
                    </a>
                    <form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="post" class="card-footer add-to-cart-form">
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="quantity_{{ product.id }}" name="quantity" value="1" min="1" max="{{ product.quantity }}" required>
                        <div class="input-group-append">
                          <button class="btn btn-outline-secondary btn-plus" type="button" data-product-id="{{ product.id }}">+</button>
                          <button class="btn btn-outline-secondary btn-minus" type="button" data-product-id="{{ product.id }}">-</button>
                        </div>
                      </div>
                      <button type="submit" class="btn btn-primary btn-sm btn-block mt-2">Add to Cart</button>
                    </form>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="col-12">
              <p class="text-center">No products found.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Product Details Modal -->
  <div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productDetailsModalLabel">Product Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <h4 id="productName">Loading...</h4>
          <p><strong>Description:</strong> <span id="productDescription"></span></p>
          <p><strong>Price:</strong> KES <span id="productPrice"></span></p>
          <p><strong>Quantity Available:</strong> <span id="productQuantity"></span></p>
          <!-- Image Carousel -->
          <div id="productImagesCarousel" class="carousel slide" data-ride="carousel">
            <div class="carousel-inner" id="productImages"></div>
            <a class="carousel-control-prev" href="#productImagesCarousel" role="button" data-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#productImagesCarousel" role="button" data-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </div>
          <!-- Add to Cart Form -->
          <form id="productAddToCartForm" action="{{ url_for('add_to_cart', product_id=0) }}" method="post" class="add-to-cart-form mt-3">
            <div class="input-group input-group-sm">
              <input type="number" class="form-control" id="modalQuantity" name="quantity" value="1" min="1" required>
              <div class="input-group-append">
                <button class="btn btn-outline-secondary btn-plus" type="button" data-product-id="modal">+</button>
                <button class="btn btn-outline-secondary btn-minus" type="button" data-product-id="modal">-</button>
              </div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm btn-block mt-2">Add to Cart</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Wholesalers Login</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('login') }}" method="POST" id="loginForm">
            <div class="form-group">
              <label for="loginEmail">Email address</label>
              <input type="email" class="form-control" id="loginEmail" name="email" placeholder="Enter email" required>
              <div id="emailValidation" class="validation-message"></div>
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Enter password" required>
                <i class="fas fa-eye toggle-icon" id="toggleLoginPassword"></i>
              </div>
              <div id="passwordValidation" class="validation-message"></div>
            </div>
            <button type="submit" class="btn btn-success btn-block" id="loginSubmitBtn" disabled>Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerModalLabel">Wholesalers Registration</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="categorySelection">
            <p>Please select your category:</p>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="category" id="household" value="household">
              <label class="form-check-label" for="household">Household (consumer)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="category" id="retail" value="retail">
              <label class="form-check-label" for="retail">Retail Business</label>
            </div>
            <button type="button" id="continueBtn" class="btn btn-success btn-block mt-3">Continue</button>
          </div>
          <form action="{{ url_for('register') }}" method="POST" id="registrationForm" style="display: none;">
            <div class="form-group">
              <label for="companyName" id="companyNameLabel">Username</label>
              <input type="text" class="form-control" id="companyName" name="companyName" placeholder="Enter username" required>
              <div id="companyNameValidation" class="validation-message"></div>
            </div>
            <div class="form-group">
              <label for="contactPerson">Contact Person</label>
              <input type="text" class="form-control" id="contactPerson" name="contactPerson" placeholder="Enter contact person name" required>
              <div id="contactPersonValidation" class="validation-message"></div>
            </div>
            <div class="form-group">
  <label for="email">Email address</label>
  <input type="email" class="form-control" id="email" name="email" placeholder="Enter email" required>
  <div id="emailValidation" class="validation-message">
    <ul class="password-checklist">
      <li id="atSymbolCheck">Email must include @ symbol</li>
      <li id="formatCheck">Valid email format (e.g., user@domain.com)</li>
    </ul>
  </div>
</div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" class="form-control" id="phone" name="phone" placeholder="Enter phone number" required>
              <div id="phoneValidation" class="validation-message"></div>
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <textarea class="form-control" id="address" name="address" rows="3" placeholder="Describe your address" required></textarea>
              <div id="addressValidation" class="validation-message"></div>
            </div>
            <div class="form-group">
              <label for="registerPassword">Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="form-control" id="registerPassword" name="password" placeholder="Enter password (min 8 chars, mix of letters, numbers, special chars)" required>
                <i class="fas fa-eye toggle-icon" id="togglePassword"></i>
              </div>
              <div id="passwordValidation" class="validation-message">
                <ul class="password-checklist">
                  <li id="lengthCheck">At least 8 characters</li>
                  <li id="uppercaseCheck">At least one uppercase letter</li>
                  <li id="lowercaseCheck">At least one lowercase letter</li>
                  <li id="numberCheck">At least one number</li>
                  <li id="specialCharCheck">At least one special character</li>
                </ul>
              </div>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password</label>
              <div class="password-input-wrapper">
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Confirm password" required>
                <i class="fas fa-eye toggle-icon" id="toggleConfirmPassword"></i>
              </div>
              <div id="confirmPasswordValidation" class="validation-message"></div>
            </div>
            <button type="submit" class="btn btn-success btn-block" id="submitBtn" disabled>Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  

  <!-- Admin Login Modal -->
  <div class="modal fade" id="adminLoginModal" tabindex="-1" aria-labelledby="adminLoginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adminLoginModalLabel">Admin Login</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('admin_login') }}" method="POST" id="adminLoginForm">
            <div class="form-group">
              <label for="admin_username">Username</label>
              <input type="text" class="form-control" id="admin_username" name="admin_username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
              <label for="admin_password">Password</label>
              <input type="password" class="form-control" id="admin_password" name="admin_password" placeholder="Enter password" required>
            </div>
            <button type="submit" class="btn btn-success btn-block">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">Your Cart</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          {% if current_user.is_authenticated %}
            <h5>Here's your cart, {{ current_user.company_name }}</h5>
            <ul class="list-unstyled">
              {% set total_amount = namespace(value=0) %}
              {% for cart_item in cart_items %}
                {% set item_total = cart_item.product.price * cart_item.quantity %}
                {% set total_amount.value = total_amount.value + item_total %}
                <li class="mb-3 p-3 bg-light rounded">
                  <h6>{{ cart_item.product.name }}</h6>
                  <p>Price: KES {{ cart_item.product.price }}</p>
                  <p>Quantity: {{ cart_item.quantity }}</p>
                  <p>Item Total: KES {{ item_total }}</p>
                  <form action="{{ url_for('remove_from_cart', product_id=cart_item.product_id) }}" method="post">
                    <button type="submit" class="btn-delete">Delete</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
            <p class="total-amount">Total Amount: KES {{ total_amount.value }}</p>
            <button style="display: none !important;" class="btn-checkout" data-toggle="modal" data-target="#checkoutModal" data-dismiss="modal">Checkout</button>
          {% else %}
            <p>Please log in to view your cart.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          {% if current_user.is_authenticated %}
            <div class="alert-section">
              <p><strong>Please send KES {{ cart_total }} to M-Pesa number 0712345678</strong></p>
              <p><strong>Enter the transaction code below:</strong></p>
            </div>
            <ul class="list-unstyled">
              {% set total_amount = namespace(value=0) %}
              {% for cart_item in cart_items %}
                {% set item_total = cart_item.product.price * cart_item.quantity %}
                {% set total_amount.value = total_amount.value + item_total %}
                <li class="mb-3 p-3 bg-light rounded">
                  <h6>{{ cart_item.product.name }}</h6>
                  <p>Price: KES {{ cart_item.product.price }}</p>
                  <p>Quantity: {{ cart_item.quantity }}</p>
                  <p>Item Total: KES {{ item_total }}</p>
                </li>
              {% endfor %}
            </ul>
            <p class="total-amount">Total Amount: KES {{ total_amount.value }}</p>
            <form action="{{ url_for('checkout') }}" method="POST" id="checkoutForm">
              <div class="form-group">
                <label for="transaction-code">Transaction Code:</label>
                <input type="text" class="form-control" id="transaction-code" name="transaction-code" placeholder="Enter transaction code" required>
              </div>
              <button type="submit" class="btn-checkout">Checkout</button>
            </form>
          {% else %}
            <p>Please log in to proceed with checkout.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Modal -->
  <div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ordersModalLabel">Your Orders</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">
          {% if current_user.is_authenticated %}
            <ul class="list-unstyled">
              {% for order in orders %}
                <li class="mb-3 p-3 bg-light rounded">
                  <p><strong>Product:</strong> {{ order.product.name }}</p>
                  <p><strong>Quantity:</strong> {{ order.quantity }}</p>
                  <p><strong>Total Price:</strong> KES {{ order.total_price }}</p>
                  <p><strong>Ordered At:</strong> {{ order.ordered_at }}</p>
                  <p><strong>Status:</strong> {{ order.status | capitalize }}</p>
                  {% if order.status == 'pending' %}
                    <form action="{{ url_for('cancel_order', order_id=order.id) }}" method="post">
                      <button type="submit" class="btn-delete">Cancel Order</button>
                    </form>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>Please log in to view your orders.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
$(document).ready(function() {
  // Sidebar toggle for small screens
  $('#sidebarToggle').on('click', function() {
    $('#sidebarContent').slideToggle(200);
    $(this).find('i').toggleClass('fa-bars fa-times');
  });

  // Ensure sidebar is hidden by default on small screens
  if ($(window).width() < 768) {
    $('#sidebarContent').hide();
  }

  // Handle window resize
  $(window).resize(function() {
    if ($(window).width() >= 768) {
      $('#sidebarContent').show();
      $('#sidebarToggle').find('i').removeClass('fa-times').addClass('fa-bars');
    } else {
      $('#sidebarContent').hide();
    }
  });

  // Populate product details modal
  $('.product-link').on('click', function(e) {
    e.preventDefault();
    try {
      var productId = $(this).attr('data-id');
      var name = $(this).attr('data-name');
      var description = $(this).attr('data-description') || 'No description available';
      var price = $(this).attr('data-price');
      var quantity = $(this).attr('data-quantity');
      var images = $(this).attr('data-images') ? $(this).attr('data-images').split(',') : [];

      if (!productId || !name || !price || !quantity) {
        console.error('Missing product data:', { id: productId, name: name, price: price, quantity: quantity });
        alert('Error: Product data is incomplete.');
        return;
      }

      $('#productName').text(name);
      $('#productDescription').text(description);
      $('#productPrice').text(parseFloat(price).toFixed(2));
      $('#productQuantity').text(quantity);

      $('#productImages').empty();
      if (images.length > 0) {
        images.forEach(function(image, index) {
          if (image.trim()) {
            var activeClass = index === 0 ? 'active' : '';
            var imageUrl = '/static/uploads/' + image.trim();
            $('#productImages').append(`
              <div class="carousel-item ${activeClass}">
                <img src="${imageUrl}" class="d-block w-100 product-carousel-img" alt="${name}">
              </div>
            `);
            console.log('Added carousel image:', imageUrl);
          }
        });
      } else {
        $('#productImages').append(`
          <div class="carousel-item active">
            <img src="/static/uploads/placeholder.jpg" class="d-block w-100 product-carousel-img" alt="No image available">
          </div>
        `);
        console.log('No images available, using placeholder');
      }

      var baseUrl = '{{ url_for("add_to_cart", product_id=0) }}'.replace('/0', `/${productId}`);
      $('#productAddToCartForm').attr('action', baseUrl);
      $('#modalQuantity').attr('max', quantity).val(1);

      console.log('Modal populated:', {
        action: baseUrl,
        maxQuantity: quantity
      });

      $('#productDetailsModal').modal('show');
    } catch (error) {
      console.error('Error populating modal:', error);
      alert('Error loading product details. Please try again.');
    }
  });

  // Plus/Minus buttons for quantity input
  $('.btn-plus').on('click', function() {
    var productId = $(this).data('product-id');
    var input = productId === 'modal' ? $('#modalQuantity') : $('#quantity_' + productId);
    var newValue = parseInt(input.val()) + 1;
    if (newValue <= parseInt(input.attr('max'))) {
      input.val(newValue);
      console.log('Plus button clicked for product ' + productId + ', new value: ' + newValue);
    } else {
      alert('Cannot exceed available quantity.');
    }
  });

  $('.btn-minus').on('click', function() {
    var productId = $(this).data('product-id');
    var input = productId === 'modal' ? $('#modalQuantity') : $('#quantity_' + productId);
    var newValue = parseInt(input.val()) - 1;
    if (newValue >= 1) {
      input.val(newValue);
      console.log('Minus button clicked for product ' + productId + ', new value: ' + newValue);
    }
  });

  // Debug add to cart form submission
  $('.add-to-cart-form').on('submit', function(e) {
    var quantity = $(this).find('input[name="quantity"]').val();
    console.log('Add to cart submitted for ' + $(this).attr('action') + ', quantity: ' + quantity);
  });

  // Debug modal triggers
  $('[data-toggle="modal"]').on('click', function(e) {
    e.preventDefault();
    var target = $(this).data('target');
    console.log('Modal trigger clicked: ' + target);
    $(target).modal('show');
  });

  // Debug modal events
  $('.modal').on('show.bs.modal', function() {
    console.log('Modal opened: #' + $(this).attr('id'));
  }).on('hide.bs.modal', function() {
    console.log('Modal closed: #' + $(this).attr('id'));
    $('#loginForm input, #registrationForm input, #adminLoginForm input, #checkoutForm input, #productAddToCartForm input').each(function() {
      console.log('Input state on modal hide:', {
        id: $(this).attr('id'),
        value: $(this).attr('type') === 'password' ? '[HIDDEN]' : $(this).val()
      });
    });
  });

  // Category selection for registration
  $('#continueBtn').on('click', function() {
    var selectedCategory = $('input[name="category"]:checked').val();
    if (selectedCategory) {
      $('#registrationForm').show();
      $('#categorySelection').hide();
      $('#companyNameLabel').text(selectedCategory === 'household' ? 'Surname' : 'Company Name');
      console.log('Category selected: ' + selectedCategory);
      // Trigger initial validation to show feedback on form display
      validateRegistrationForm();
    } else {
      alert('Please select a category.');
    }
  });

  // Real-time Registration Validation
  function validateRegistrationForm() {
    var companyName = $('#companyName').val().trim();
    var contactPerson = $('#contactPerson').val().trim();
    var email = $('#email').val().trim();
    var phone = $('#phone').val().trim();
    var address = $('#address').val().trim();
    var password = $('#registerPassword').val().trim();
    var confirmPassword = $('#confirmPassword').val().trim();

    var isValid = true;

    // Company Name/Surname Validation
    if (companyName === '') {
      $('#companyNameValidation').text('Please enter a name').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else if (!/^[a-zA-Z\s]+$/.test(companyName)) {
      $('#companyNameValidation').text('Only letters and spaces allowed').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else {
      $('#companyNameValidation').text('Valid name').addClass('validation-success').removeClass('validation-error');
    }

    // Contact Person Validation
    if (contactPerson === '') {
      $('#contactPersonValidation').text('Please enter a contact person name').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else if (!/^[a-zA-Z\s]+$/.test(contactPerson)) {
      $('#contactPersonValidation').text('Only letters and spaces allowed').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else {
      $('#contactPersonValidation').text('Valid contact person name').addClass('validation-success').removeClass('validation-error');
    }

    // Email Validation
    var emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (email === '') {
      $('#emailValidation').text('Please enter an email').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else if (!email.includes('@')) {
      $('#emailValidation').text('Email must include @ symbol').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else if (!emailRegex.test(email)) {
      $('#emailValidation').text('Please enter a valid email (e.g., user@domain.com)').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else {
      $('#emailValidation').text('Valid email').addClass('validation-success').removeClass('validation-error');
    }

    // Phone Number Validation
    var phoneRegex = /^\d{10,15}$/;
    if (phone === '') {
      $('#phoneValidation').text('Please enter a phone number').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else if (!/^\d+$/.test(phone)) {
      $('#phoneValidation').text('Only numbers allowed').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else if (!phoneRegex.test(phone)) {
      $('#phoneValidation').text('Must be 10–15 digits').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else {
      $('#phoneValidation').text('Valid phone number').addClass('validation-success').removeClass('validation-error');
    }

    // Address Validation
    if (address === '') {
      $('#addressValidation').text('Please enter an address').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else {
      $('#addressValidation').text('Valid address').addClass('validation-success').removeClass('validation-error');
    }

    // Password Validation
    var isPasswordValid = true;
    if (password === '') {
      $('#lengthCheck, #uppercaseCheck, #lowercaseCheck, #numberCheck, #specialCharCheck').addClass('invalid').removeClass('valid');
      $('#passwordValidation').text('Please enter a password').addClass('validation-error').removeClass('validation-success');
      isPasswordValid = false;
      isValid = false;
    } else {
      // Length Check
      if (password.length < 8) {
        $('#lengthCheck').addClass('invalid').removeClass('valid');
        isPasswordValid = false;
      } else {
        $('#lengthCheck').addClass('valid').removeClass('invalid');
      }

      // Uppercase Check
      if (!/[A-Z]/.test(password)) {
        $('#uppercaseCheck').addClass('invalid').removeClass('valid');
        isPasswordValid = false;
      } else {
        $('#uppercaseCheck').addClass('valid').removeClass('invalid');
      }

      // Lowercase Check
      if (!/[a-z]/.test(password)) {
        $('#lowercaseCheck').addClass('invalid').removeClass('valid');
        isPasswordValid = false;
      } else {
        $('#lowercaseCheck').addClass('valid').removeClass('invalid');
      }

      // Number Check
      if (!/\d/.test(password)) {
        $('#numberCheck').addClass('invalid').removeClass('valid');
        isPasswordValid = false;
      } else {
        $('#numberCheck').addClass('valid').removeClass('invalid');
      }

      // Special Character Check
      if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
        $('#specialCharCheck').addClass('invalid').removeClass('valid');
        isPasswordValid = false;
      } else {
        $('#specialCharCheck').addClass('valid').removeClass('invalid');
      }

      if (isPasswordValid) {
        $('#passwordValidation').text('Password is strong').addClass('validation-success').removeClass('validation-error');
      } else {
        $('#passwordValidation').text('Password does not meet requirements').addClass('validation-error').removeClass('validation-success');
        isValid = false;
      }
    }

    // Confirm Password Validation
    var passwordsMatch = password === confirmPassword && password !== '';
    if (confirmPassword === '') {
      $('#confirmPasswordValidation').text('Please confirm your password').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else if (!passwordsMatch) {
      $('#confirmPasswordValidation').text('Passwords do not match').addClass('validation-error').removeClass('validation-success');
      isValid = false;
    } else {
      $('#confirmPasswordValidation').text('Passwords match').addClass('validation-success').removeClass('validation-error');
    }

    // Enable submit button only if all fields are valid
    $('#submitBtn').prop('disabled', !isValid);

    // Optional AJAX for server-side password validation
    if (password !== '' && confirmPassword !== '') {
      $.ajax({
        url: '{{ url_for("validate_password") }}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ password: password, confirmPassword: confirmPassword }),
        success: function(response) {
          console.log('Server validation response:', response);
          if (!response.isPasswordValid) {
            $('#passwordValidation').text(response.passwordErrors.join(', ')).addClass('validation-error').removeClass('validation-success');
            isPasswordValid = false;
            isValid = false;
          }
          if (!response.passwordsMatch) {
            $('#confirmPasswordValidation').text('Passwords do not match').addClass('validation-error').removeClass('validation-success');
            isValid = false;
          }
          $('#submitBtn').prop('disabled', !isValid);
        },
        error: function(xhr, status, error) {
          console.error('Password AJAX error:', status, error);
          // Allow client-side validation to proceed even if server fails
        }
      });
    }

    return isValid;
  }

  // Dedicated email input event handler for immediate feedback
  $('#email').on('input keyup change paste', function(e) {
    console.log('Email input event:', {
      field: $(this).attr('id'),
      eventType: e.type,
      value: $(this).val()
    });
    validateRegistrationForm();
  });

  // Bind real-time validation to other registration form inputs
  $('#registrationForm input:not(#email), #registrationForm textarea').on('input keyup change paste', function(e) {
    console.log('Registration input event:', {
      field: $(this).attr('id'),
      eventType: e.type,
      value: $(this).attr('type') === 'password' ? '[HIDDEN]' : $(this).val()
    });
    validateRegistrationForm();
  });

  // Password visibility toggle
  $('#togglePassword').on('click', function() {
    var type = $('#registerPassword').attr('type') === 'password' ? 'text' : 'password';
    $('#registerPassword').attr('type', type);
    $(this).toggleClass('fa-eye fa-eye-slash');
    console.log('Password visibility toggled:', { type: type });
    validateRegistrationForm();
  });

  $('#toggleConfirmPassword').on('click', function() {
    var type = $('#confirmPassword').attr('type') === 'password' ? 'text' : 'password';
    $('#confirmPassword').attr('type', type);
    $(this).toggleClass('fa-eye fa-eye-slash');
    console.log('Confirm password visibility toggled:', { type: type });
    validateRegistrationForm();
  });

  $('#toggleLoginPassword').on('click', function() {
    var type = $('#loginPassword').attr('type') === 'password' ? 'text' : 'password';
    $('#loginPassword').attr('type', type);
    $(this).toggleClass('fa-eye fa-eye-slash');
    console.log('Login password visibility toggled:', { type: type });
    validateLoginForm();
  });

  // Form submission
  $('#registrationForm').on('submit', function(e) {
    if (!validateRegistrationForm()) {
      e.preventDefault();
      alert('Please correct the errors in the form.');
      console.warn('Form submission blocked: Validation failed');
    } else {
      console.log('Form submission allowed');
    }
  });

  // Login Validation
  function validateLoginForm() {
    var email = $('#loginEmail').val().trim();
    var password = $('#loginPassword').val().trim();
    var isEmailValid = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email);
    var isPasswordValid = password.length > 0;

    if (email === '') {
      $('#emailValidation').text('Please enter an email').addClass('validation-error').removeClass('validation-success');
    } else if (!isEmailValid) {
      $('#emailValidation').text('Please enter a valid email').addClass('validation-error').removeClass('validation-success');
    } else {
      $('#emailValidation').text('Email is valid').addClass('validation-success').removeClass('validation-error');
    }

    if (password === '') {
      $('#passwordValidation').text('Please enter a password').addClass('validation-error').removeClass('validation-success');
    } else {
      $('#passwordValidation').text('').removeClass('validation-error validation-success');
    }

    $('#loginSubmitBtn').prop('disabled', !(isEmailValid && isPasswordValid));
    console.log('Login validation result:', {
      isEmailValid: isEmailValid,
      isPasswordValid: isPasswordValid,
      submitDisabled: $('#loginSubmitBtn').prop('disabled')
    });
  }

  $('#loginEmail, #loginPassword').on('input blur change keyup paste', function(e) {
    console.log('Login input event:', {
      field: $(this).attr('id'),
      eventType: e.type,
      value: $(this).attr('id') === 'loginEmail' ? $(this).val() : '[HIDDEN]'
    });
    validateLoginForm();
  });

  $('#loginForm').on('submit', function(e) {
    var email = $('#loginEmail').val().trim();
    var password = $('#loginPassword').val().trim();
    console.log('Login form submission:', {
      email: email,
      password: '[HIDDEN]'
    });

    if (email === '' || password === '') {
      e.preventDefault();
      alert('Please fill in all fields.');
      console.warn('Login submission blocked: Empty fields');
    }
  });

  // Admin Login Validation
  function validateAdminLoginForm() {
    var username = $('#admin_username').val().trim();
    var password = $('#admin_password').val().trim();
    var isUsernameValid = username.length > 0;
    var isPasswordValid = password.length > 0;

    $('#adminLoginForm button[type="submit"]').prop('disabled', !(isUsernameValid && isPasswordValid));
    console.log('Admin login validation result:', {
      isUsernameValid: isUsernameValid,
      isPasswordValid: isPasswordValid,
      submitDisabled: $('#adminLoginForm button[type="submit"]').prop('disabled')
    });
  }

  $('#admin_username, #admin_password').on('input blur change keyup paste', function(e) {
    console.log('Admin login input event:', {
      field: $(this).attr('id'),
      eventType: e.type,
      value: $(this).attr('id') === 'admin_username' ? $(this).val() : '[HIDDEN]'
    });
    validateAdminLoginForm();
  });

  $('#adminLoginForm').on('submit', function(e) {
    var username = $('#admin_username').val().trim();
    var password = $('#admin_password').val().trim();
    console.log('Admin login form submission:', {
      username: username,
      password: '[HIDDEN]'
    });

    if (username === '' || password === '') {
      e.preventDefault();
      alert('Please fill in all fields.');
      console.warn('Admin login submission blocked: Empty fields');
    }
  });

  // Debug modal open
  $('#loginModal').on('show.bs.modal', function() {
    validateLoginForm();
  });

  $('#registerModal').on('show.bs.modal', function() {
    validateRegistrationForm();
  });

  $('#adminLoginModal').on('show.bs.modal', function() {
    validateAdminLoginForm();
  });

  // Prevent modal from clearing inputs
  $('#loginModal, #registerModal, #adminLoginModal, #checkoutModal, #productDetailsModal').on('hidden.bs.modal', function() {
    var formId = $(this).attr('id') === 'loginModal' ? '#loginForm' :
                 $(this).attr('id') === 'registerModal' ? '#registrationForm' :
                 $(this).attr('id') === 'adminLoginModal' ? '#adminLoginForm' :
                 $(this).attr('id') === 'checkoutModal' ? '#checkoutForm' : '#productAddToCartForm';
    $(formId)[0].reset = function() {
      console.log('Form reset prevented for ' + formId);
    };
  });

  // Debug checkout form submission
  $('#checkoutForm').on('submit', function() {
    const transactionCode = $('#transaction-code').val();
    console.log('Checkout form submitted:', { transactionCode });
  });

  // Debug cancel order submission
  $('.btn-delete').on('click', function() {
    const form = $(this).closest('form');
    console.log('Cancel order or remove item clicked:', { action: form.attr('action') });
  });
});
</script>
</body>
</html>
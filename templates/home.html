<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wholesale Management</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Wholesale Management</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active"><a class="nav-link" href="{{ url_for('home') }}">Home</a></li>
        {% if current_user.is_authenticated %}
          <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#cartModal">My Cart</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#ordersModal">My Orders</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('profile') }}">Profile</a></li>
          <li class="nav-item">
            <form action="{{ url_for('logout') }}" method="post">
              <button type="submit" class="btn btn-link nav-link">Logout</button>
            </form>
          </li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#loginModal">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#registerModal">Register</a></li>
        {% endif %}
        <li class="nav-item"><a class="nav-link" href="#" data-toggle="modal" data-target="#adminLoginModal">Admin</a></li>
      </ul>
      <form class="form-inline my-2 my-lg-0" action="{{ url_for('search') }}" method="GET">
        <input class="form-control mr-sm-2" type="search" placeholder="Search products" name="query">
        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
      </form>
    </div>
  </nav>

  <!-- Flash Messages -->
  <div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Main Content with Sidebar -->
  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 sidebar" id="sidebar">
        <button class="btn btn-primary btn-sm d-md-none mb-3" type="button" id="sidebarToggle">
          <i class="fas fa-bars"></i> Filters
        </button>
        <div class="sidebar-content" id="sidebarContent">
          <h5 class="sidebar-title">Filters</h5>
          <!-- Categories -->
          <div class="mb-3">
            <h6>Categories</h6>
            <ul class="list-unstyled">
              <li><a href="{{ url_for('home') }}" class="category-link {{ '' if not selected_category else 'text-muted' }}">All Categories</a></li>
              {% for category in categories %}
                <li><a href="{{ url_for('search', category_id=category.id) }}" class="category-link {{ 'active' if selected_category == category.id else '' }}">{{ category.name }}</a></li>
              {% endfor %}
            </ul>
          </div>
          <!-- Sort by Price -->
          <div class="mb-3">
            <h6>Sort by Price</h6>
            <form action="{{ url_for('search') }}" method="GET" id="sortForm">
              <select name="sort" class="form-control form-control-sm" onchange="this.form.submit()">
                <option value="">Select</option>
                <option value="price_asc" {{ 'selected' if sort == 'price_asc' else '' }}>Price: Low to High</option>
                <option value="price_desc" {{ 'selected' if sort == 'price_desc' else '' }}>Price: High to Low</option>
              </select>
              {% if selected_category %}
                <input type="hidden" name="category_id" value="{{ selected_category }}">
              {% endif %}
              {% if query %}
                <input type="hidden" name="query" value="{{ query }}">
              {% endif %}
              {% if min_price %}
                <input type="hidden" name="min_price" value="{{ min_price }}">
              {% endif %}
              {% if max_price %}
                <input type="hidden" name="max_price" value="{{ max_price }}">
              {% endif %}
            </form>
          </div>
          <!-- Price Range -->
          <div class="mb-3">
            <h6>Price Range (KES)</h6>
            <form action="{{ url_for('search') }}" method="GET" id="priceRangeForm">
              <div class="form-group">
                <label for="minPrice">Min</label>
                <input type="number" class="form-control form-control-sm" id="minPrice" name="min_price" value="{{ min_price or '' }}" min="0" placeholder="0">
              </div>
              <div class="form-group">
                <label for="maxPrice">Max</label>
                <input type="number" class="form-control form-control-sm" id="maxPrice" name="max_price" value="{{ max_price or '' }}" min="0" placeholder="10000">
              </div>
              <button type="submit" class="btn btn-primary btn-sm btn-block">Apply</button>
              {% if selected_category %}
                <input type="hidden" name="category_id" value="{{ selected_category }}">
              {% endif %}
              {% if sort %}
                <input type="hidden" name="sort" value="{{ sort }}">
              {% endif %}
              {% if query %}
                <input type="hidden" name="query" value="{{ query }}">
              {% endif %}
            </form>
          </div>
        </div>
      </div>
      <!-- Product Display -->
      <div class="col-md-9 col-lg-10">
        <div class="row g-2">
          {% if products %}
            {% for product in products %}
              {% if product.quantity > 0 %}
                <div class="col-lg-3 col-md-4 col-sm-6">
                  <div class="card h-100">
                    <a href="#" class="product-link" data-toggle="modal" data-target="#productDetailsModal"
                       data-id="{{ product.id }}"
                       data-name="{{ product.name }}"
                       data-description="{{ product.description }}"
                       data-price="{{ product.price }}"
                       data-quantity="{{ product.quantity }}"
                       data-images="{{ product.images }}">
                      <img src="{{ url_for('static', filename='uploads/' + product.images.split(',')[0]) }}" alt="{{ product.name }}" class="card-img-top">
                      <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">Price: KES {{ product.price }}</p>
                        <p class="card-text">Available: {{ product.quantity }}</p>
                      </div>
                    </a>
                    <form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="post" class="card-footer add-to-cart-form">
                      <div class="input-group input-group-sm">
                        <input type="number" class="form-control" id="quantity_{{ product.id }}" name="quantity" value="1" min="1" max="{{ product.quantity }}" required>
                        <div class="input-group-append">
                          <button class="btn btn-outline-secondary btn-plus" type="button" data-product-id="{{ product.id }}">+</button>
                          <button class="btn btn-outline-secondary btn-minus" type="button" data-product-id="{{ product.id }}">-</button>
                        </div>
                      </div>
                      <button type="submit" class="btn btn-primary btn-sm btn-block mt-2">Add to Cart</button>
                    </form>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="col-12">
              <p class="text-center">No products found.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Product Details Modal -->
  <div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productDetailsModalLabel">Product Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h4 id="productName">Loading...</h4>
          <p><strong>Description:</strong> <span id="productDescription"></span></p>
          <p><strong>Price:</strong> KES <span id="productPrice"></span></p>
          <p><strong>Quantity Available:</strong> <span id="productQuantity"></span></p>
          <!-- Image Carousel -->
          <div id="productImagesCarousel" class="carousel slide" data-ride="carousel">
            <div class="carousel-inner" id="productImages"></div>
            <a class="carousel-control-prev" href="#productImagesCarousel" role="button" data-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#productImagesCarousel" role="button" data-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </div>
          <!-- Add to Cart Form -->
          <form id="productAddToCartForm" action="{{ url_for('add_to_cart', product_id=0) }}" method="post" class="add-to-cart-form mt-3">
            <div class="input-group input-group-sm">
              <input type="number" class="form-control" id="modalQuantity" name="quantity" value="1" min="1" required>
              <div class="input-group-append">
                <button class="btn btn-outline-secondary btn-plus" type="button" data-product-id="modal">+</button>
                <button class="btn btn-outline-secondary btn-minus" type="button" data-product-id="modal">-</button>
              </div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm btn-block mt-2">Add to Cart</button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Wholesalers Login</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('login') }}" method="POST" id="loginForm">
            <div class="form-group">
              <label for="loginEmail">Email address</label>
              <input type="email" class="form-control" id="loginEmail" name="email" placeholder="Enter email" required>
              <div id="emailValidation" class="validation-message"></div>
            </div>
            <div class="form-group password-toggle">
              <label for="loginPassword">Password</label>
              <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Enter password" required>
              <i class="fas fa-eye toggle-icon" id="toggleLoginPassword"></i>
              <div id="passwordValidation" class="validation-message"></div>
            </div>
            <button type="submit" class="btn btn-success btn-block" id="loginSubmitBtn" disabled>Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerModalLabel">Wholesalers Registration</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="categorySelection">
            <p>Please select your category:</p>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="category" id="household" value="household">
              <label class="form-check-label" for="household">Household (consumer)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="category" id="retail" value="retail">
              <label class="form-check-label" for="retail">Retail Business</label>
            </div>
            <button type="button" id="continueBtn" class="btn btn-success btn-block mt-3">Continue</button>
          </div>
          <form action="{{ url_for('register') }}" method="POST" id="registrationForm" style="display: none;">
            <div class="form-group">
              <label for="companyName" id="companyNameLabel">Username</label>
              <input type="text" class="form-control" id="companyName" name="companyName" placeholder="Enter username" required>
            </div>
            <div class="form-group">
              <label for="contactPerson">Contact Person</label>
              <input type="text" class="form-control" id="contactPerson" name="contactPerson" placeholder="Enter contact person name" required>
            </div>
            <div class="form-group">
              <label for="email">Email address</label>
              <input type="email" class="form-control" id="email" name="email" placeholder="Enter email" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" class="form-control" id="phone" name="phone" placeholder="Enter phone number" required>
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <textarea class="form-control" id="address" name="address" rows="3" placeholder="Describe your address" required></textarea>
            </div>
            <div class="form-group password-toggle">
              <label for="registerPassword">Password</label>
              <input type="password" class="form-control" id="registerPassword" name="password" placeholder="Enter password (min 8 chars, mix of letters, numbers, special chars)" required>
              <i class="fas fa-eye toggle-icon" id="togglePassword"></i>
              <div id="passwordValidation" class="validation-message"></div>
            </div>
            <div class="form-group password-toggle">
              <label for="confirmPassword">Confirm Password</label>
              <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Confirm password" required>
              <i class="fas fa-eye toggle-icon" id="toggleConfirmPassword"></i>
              <div id="confirmPasswordValidation" class="validation-message"></div>
            </div>
            <button type="submit" class="btn btn-success btn-block" id="submitBtn" disabled>Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div class="modal fade" id="adminLoginModal" tabindex="-1" aria-labelledby="adminLoginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adminLoginModalLabel">Admin Login</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="{{ url_for('admin_login') }}" method="POST" id="adminLoginForm">
            <div class="form-group">
              <label for="admin_username">Username</label>
              <input type="text" class="form-control" id="admin_username" name="admin_username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
              <label for="admin_password">Password</label>
              <input type="password" class="form-control" id="admin_password" name="admin_password" placeholder="Enter password" required>
            </div>
            <button type="submit" class="btn btn-success btn-block">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cartModalLabel">Your Cart</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% if current_user.is_authenticated %}
            <h5>Here's your cart, {{ current_user.company_name }}</h5>
            <ul class="list-unstyled">
              {% set total_amount = namespace(value=0) %}
              {% for cart_item in cart_items %}
                {% set item_total = cart_item.product.price * cart_item.quantity %}
                {% set total_amount.value = total_amount.value + item_total %}
                <li class="mb-3 p-3 bg-light rounded">
                  <h6>{{ cart_item.product.name }}</h6>
                  <p>Price: KES {{ cart_item.product.price }}</p>
                  <p>Quantity: {{ cart_item.quantity }}</p>
                  <p>Item Total: KES {{ item_total }}</p>
                  <form action="{{ url_for('remove_from_cart', product_id=cart_item.product_id) }}" method="post">
                    <button type="submit" class="btn-delete">Delete</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
            <p class="total-amount">Total Amount: KES {{ total_amount.value }}</p>
            <button style="display: none !important;" class="btn-checkout" data-toggle="modal" data-target="#checkoutModal" data-dismiss="modal">Checkout</button>
          {% else %}
            <p>Please log in to view your cart.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% if current_user.is_authenticated %}
            <div class="alert-section">
              <p><strong>Please send KES {{ cart_total }} to M-Pesa number 0712345678</strong></p>
              <p><strong>Enter the transaction code below:</strong></p>
            </div>
            <ul class="list-unstyled">
              {% set total_amount = namespace(value=0) %}
              {% for cart_item in cart_items %}
                {% set item_total = cart_item.product.price * cart_item.quantity %}
                {% set total_amount.value = total_amount.value + item_total %}
                <li class="mb-3 p-3 bg-light rounded">
                  <h6>{{ cart_item.product.name }}</h6>
                  <p>Price: KES {{ cart_item.product.price }}</p>
                  <p>Quantity: {{ cart_item.quantity }}</p>
                  <p>Item Total: KES {{ item_total }}</p>
                </li>
              {% endfor %}
            </ul>
            <p class="total-amount">Total Amount: KES {{ total_amount.value }}</p>
            <form action="{{ url_for('checkout') }}" method="POST" id="checkoutForm">
              <div class="form-group">
                <label for="transaction-code">Transaction Code:</label>
                <input type="text" class="form-control" id="transaction-code" name="transaction-code" placeholder="Enter transaction code" required>
              </div>
              <button type="submit" class="btn-checkout">Checkout</button>
            </form>
          {% else %}
            <p>Please log in to proceed with checkout.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Modal -->
  <div class="modal fade" id="ordersModal" tabindex="-1" aria-labelledby="ordersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ordersModalLabel">Your Orders</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% if current_user.is_authenticated %}
            <ul class="list-unstyled">
              {% for order in orders %}
                <li class="mb-3 p-3 bg-light rounded">
                  <p><strong>Product:</strong> {{ order.product.name }}</p>
                  <p><strong>Quantity:</strong> {{ order.quantity }}</p>
                  <p><strong>Total Price:</strong> KES {{ order.total_price }}</p>
                  <p><strong>Ordered At:</strong> {{ order.ordered_at }}</p>
                  <p><strong>Status:</strong> {{ order.status | capitalize }}</p>
                  {% if order.status == 'pending' %}
                    <form action="{{ url_for('cancel_order', order_id=order.id) }}" method="post">
                      <button type="submit" class="btn-delete">Cancel Order</button>
                    </form>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>Please log in to view your orders.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    $(document).ready(function() {
      // Sidebar toggle for small screens
      $('#sidebarToggle').on('click', function() {
        $('#sidebarContent').slideToggle(200);
        $(this).find('i').toggleClass('fa-bars fa-times');
      });

      // Ensure sidebar is hidden by default on small screens
      if ($(window).width() < 768) {
        $('#sidebarContent').hide();
      }

      // Handle window resize
      $(window).resize(function() {
        if ($(window).width() >= 768) {
          $('#sidebarContent').show();
          $('#sidebarToggle').find('i').removeClass('fa-times').addClass('fa-bars');
        } else {
          $('#sidebarContent').hide();
        }
      });

      // Populate product details modal
      $('.product-link').on('click', function(e) {
        e.preventDefault();
        try {
          // Retrieve data attributes
          var productId = $(this).attr('data-id');
          var name = $(this).attr('data-name');
          var description = $(this).attr('data-description') || 'No description available';
          var price = $(this).attr('data-price');
          var quantity = $(this).attr('data-quantity');
          var images = $(this).attr('data-images') ? $(this).attr('data-images').split(',') : [];

          console.log('Product link clicked:', {
            id: productId,
            name: name,
            description: description,
            price: price,
            quantity: quantity,
            images: images
          });

          // Validate data
          if (!productId || !name || !price || !quantity) {
            console.error('Missing product data:', { id: productId, name: name, price: price, quantity: quantity });
            alert('Error: Product data is incomplete.');
            return;
          }

          // Update modal content
          $('#productName').text(name);
          $('#productDescription').text(description);
          $('#productPrice').text(parseFloat(price).toFixed(2));
          $('#productQuantity').text(quantity);

          // Update carousel
          $('#productImages').empty();
          if (images.length > 0) {
            images.forEach(function(image, index) {
              if (image.trim()) {
                var activeClass = index === 0 ? 'active' : '';
                var imageUrl = '/static/uploads/' + image.trim();
                $('#productImages').append(`
                  <div class="carousel-item ${activeClass}">
                    <img src="${imageUrl}" class="d-block w-100 product-carousel-img" alt="${name}">
                  </div>
                `);
                console.log('Added carousel image:', imageUrl);
              }
            });
          } else {
            $('#productImages').append(`
              <div class="carousel-item active">
                <img src="/static/uploads/placeholder.jpg" class="d-block w-100 product-carousel-img" alt="No image available">
              </div>
            `);
            console.log('No images available, using placeholder');
          }

          // Update form action and quantity input
          var baseUrl = '{{ url_for("add_to_cart", product_id=0) }}'.replace('/0', `/${productId}`);
          $('#productAddToCartForm').attr('action', baseUrl);
          $('#modalQuantity').attr('max', quantity).val(1);

          console.log('Modal populated:', {
            action: baseUrl,
            maxQuantity: quantity
          });

          // Show modal
          $('#productDetailsModal').modal('show');
        } catch (error) {
          console.error('Error populating modal:', error);
          alert('Error loading product details. Please try again.');
        }
      });

      // Plus/Minus buttons for quantity input (both card and modal)
      $('.btn-plus').on('click', function() {
        var productId = $(this).data('product-id');
        var input = productId === 'modal' ? $('#modalQuantity') : $('#quantity_' + productId);
        var newValue = parseInt(input.val()) + 1;
        if (newValue <= parseInt(input.attr('max'))) {
          input.val(newValue);
          console.log('Plus button clicked for product ' + productId + ', new value: ' + newValue);
        } else {
          alert('Cannot exceed available quantity.');
        }
      });

      $('.btn-minus').on('click', function() {
        var productId = $(this).data('product-id');
        var input = productId === 'modal' ? $('#modalQuantity') : $('#quantity_' + productId);
        var newValue = parseInt(input.val()) - 1;
        if (newValue >= 1) {
          input.val(newValue);
          console.log('Minus button clicked for product ' + productId + ', new value: ' + newValue);
        }
      });

      // Debug add to cart form submission (both card and modal)
      $('.add-to-cart-form').on('submit', function(e) {
        var quantity = $(this).find('input[name="quantity"]').val();
        console.log('Add to cart submitted for ' + $(this).attr('action') + ', quantity: ' + quantity);
      });

      // Debug modal triggers
      $('[data-toggle="modal"]').on('click', function(e) {
        e.preventDefault();
        var target = $(this).data('target');
        console.log('Modal trigger clicked: ' + target);
        $(target).modal('show');
      });

      // Debug modal events
      $('.modal').on('show.bs.modal', function() {
        console.log('Modal opened: #' + $(this).attr('id'));
      }).on('hide.bs.modal', function() {
        console.log('Modal closed: #' + $(this).attr('id'));
        $('#loginForm input, #registrationForm input, #adminLoginForm input, #checkoutForm input, #productAddToCartForm input').each(function() {
          console.log('Input state on modal hide:', {
            id: $(this).attr('id'),
            value: $(this).attr('type') === 'password' ? '[HIDDEN]' : $(this).val()
          });
        });
      });

      // Category selection for registration
      $('#continueBtn').on('click', function() {
        var selectedCategory = $('input[name="category"]:checked').val();
        if (selectedCategory) {
          $('#registrationForm').show();
          $('#categorySelection').hide();
          $('#companyNameLabel').text(selectedCategory === 'household' ? 'Surname' : 'Company Name');
          console.log('Category selected: ' + selectedCategory);
        } else {
          alert('Please select a category.');
        }
      });

      // Register: Password validation with AJAX
      function validateRegisterPasswords() {
        var password = $('#registrationForm #registerPassword').val().trim();
        var confirmPassword = $('#registrationForm #confirmPassword').val().trim();

        console.log('Register client-side validation:', {
          password: '[HIDDEN]',
          passwordLength: password.length,
          confirmPassword: '[HIDDEN]',
          confirmPasswordLength: confirmPassword.length
        });

        if (password === '') {
          console.warn('Register password field is empty');
          $('#passwordValidation').text('Please enter a password').addClass('validation-error').removeClass('validation-success');
          $('#submitBtn').prop('disabled', true);
          return;
        }

        var passwordErrors = [];
        var isPasswordValid = true;

        if (password.length < 8) {
          passwordErrors.push('At least 8 characters required');
          isPasswordValid = false;
        }
        if (!/[A-Z]/.test(password)) {
          passwordErrors.push('At least one uppercase letter required');
          isPasswordValid = false;
        }
        if (!/[a-z]/.test(password)) {
          passwordErrors.push('At least one lowercase letter required');
          isPasswordValid = false;
        }
        if (!/\d/.test(password)) {
          passwordErrors.push('At least one number required');
          isPasswordValid = false;
        }
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
          passwordErrors.push('At least one special character required');
          isPasswordValid = false;
        }

        var passwordsMatch = password === confirmPassword && password !== '';

        if (!isPasswordValid) {
          $('#passwordValidation').text(passwordErrors.join(', ')).addClass('validation-error').removeClass('validation-success');
        } else {
          $('#passwordValidation').text('Password is strong').addClass('validation-success').removeClass('validation-error');
        }

        if (confirmPassword === '') {
          $('#confirmPasswordValidation').text('').removeClass('validation-error validation-success');
        } else if (!passwordsMatch) {
          $('#confirmPasswordValidation').text('Passwords do not match').addClass('validation-error').removeClass('validation-success');
        } else {
          $('#confirmPasswordValidation').text('Passwords match').addClass('validation-success').removeClass('validation-error');
        }

        $.ajax({
          url: '{{ url_for("validate_password") }}',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ password: password, confirmPassword: confirmPassword }),
          beforeSend: function() {
            console.log('Register AJAX sending:', {
              password: '[HIDDEN]',
              confirmPassword: '[HIDDEN]'
            });
          },
          success: function(response) {
            console.log('Register server validation response:', response);
            if (!response.isPasswordValid) {
              $('#passwordValidation').text(response.passwordErrors.join(', ')).addClass('validation-error').removeClass('validation-success');
              isPasswordValid = false;
            }
            if (!response.passwordsMatch) {
              $('#confirmPasswordValidation').text('Passwords do not match').addClass('validation-error').removeClass('validation-success');
              passwordsMatch = false;
            }
            $('#submitBtn').prop('disabled', !(isPasswordValid && passwordsMatch));
            console.log('Register validation result:', {
              isPasswordValid: isPasswordValid,
              passwordsMatch: passwordsMatch,
              submitDisabled: $('#submitBtn').prop('disabled')
            });
          },
          error: function(xhr, status, error) {
            console.error('Register AJAX error:', status, error);
            $('#passwordValidation').text('Error validating password').addClass('validation-error');
            $('#submitBtn').prop('disabled', true);
            alert('Failed to validate password. Please try again.');
          }
        });
      }

      $('#registrationForm #registerPassword, #registrationForm #confirmPassword').on('input blur change keyup paste', function(e) {
        console.log('Register input event:', {
          field: $(this).attr('id'),
          eventType: e.type,
          value: '[HIDDEN]'
        });
        validateRegisterPasswords();
      });

      $('#togglePassword').on('click', function() {
        var type = $('#registrationForm #registerPassword').attr('type') === 'password' ? 'text' : 'password';
        $('#registrationForm #registerPassword').attr('type', type);
        $(this).toggleClass('fa-eye fa-eye-slash');
        console.log('Register password visibility toggled:', { type: type });
        validateRegisterPasswords();
      });

      $('#toggleConfirmPassword').on('click', function() {
        var type = $('#registrationForm #confirmPassword').attr('type') === 'password' ? 'text' : 'password';
        $('#registrationForm #confirmPassword').attr('type', type);
        $(this).toggleClass('fa-eye fa-eye-slash');
        console.log('Register confirm password visibility toggled:', { type: type });
        validateRegisterPasswords();
      });

      $('#registrationForm').on('submit', function(e) {
        var password = $('#registrationForm #registerPassword').val().trim();
        var confirmPassword = $('#registrationForm #confirmPassword').val().trim();
        console.log('Register form submission:', {
          password: '[HIDDEN]',
          confirmPassword: '[HIDDEN]'
        });

        if (password === '') {
          e.preventDefault();
          alert('Please enter a password.');
          return;
        }
        if (password !== confirmPassword) {
          e.preventDefault();
          alert('Passwords do not match.');
        }
      });

      // Login: Client-side validation
      function validateLoginForm() {
        var email = $('#loginForm #loginEmail').val().trim();
        var password = $('#loginForm #loginPassword').val().trim();

        console.log('Login client-side validation:', {
          email: email,
          emailLength: email.length,
          password: '[HIDDEN]',
          passwordLength: password.length
        });

        var isEmailValid = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email);
        var isPasswordValid = password.length > 0;

        if (email === '') {
          $('#emailValidation').text('Please enter an email').addClass('validation-error').removeClass('validation-success');
        } else if (!isEmailValid) {
          $('#emailValidation').text('Please enter a valid email').addClass('validation-error').removeClass('validation-success');
        } else {
          $('#emailValidation').text('Email is valid').addClass('validation-success').removeClass('validation-error');
        }

        if (password === '') {
          $('#passwordValidation').text('Please enter a password').addClass('validation-error').removeClass('validation-success');
        } else {
          $('#passwordValidation').text('').removeClass('validation-error validation-success');
        }

        $('#loginSubmitBtn').prop('disabled', !(isEmailValid && isPasswordValid));
        console.log('Login validation result:', {
          isEmailValid: isEmailValid,
          isPasswordValid: isPasswordValid,
          submitDisabled: $('#loginSubmitBtn').prop('disabled')
        });
      }

      $('#loginForm #loginEmail, #loginForm #loginPassword').on('input blur change keyup paste', function(e) {
        console.log('Login input event:', {
          field: $(this).attr('id'),
          eventType: e.type,
          value: $(this).attr('id') === 'loginEmail' ? $(this).val() : '[HIDDEN]'
        });
        validateLoginForm();
      });

      $('#toggleLoginPassword').on('click', function() {
        var type = $('#loginForm #loginPassword').attr('type') === 'password' ? 'text' : 'password';
        $('#loginForm #loginPassword').attr('type', type);
        $(this).toggleClass('fa-eye fa-eye-slash');
        console.log('Login password visibility toggled:', { type: type });
        validateLoginForm();
      });

      $('#loginForm').on('submit', function(e) {
        var email = $('#loginForm #loginEmail').val().trim();
        var password = $('#loginForm #loginPassword').val().trim();
        console.log('Login form submission:', {
          email: email,
          password: '[HIDDEN]'
        });

        if (email === '' || password === '') {
          e.preventDefault();
          alert('Please fill in all fields.');
          console.warn('Login submission blocked: Empty fields');
          return;
        }

        console.log('Login form submitting to:', $(this).attr('action'));
      });

      // Admin Login: Client-side validation
      function validateAdminLoginForm() {
        var username = $('#adminLoginForm #admin_username').val().trim();
        var password = $('#adminLoginForm #admin_password').val().trim();

        console.log('Admin login client-side validation:', {
          username: username,
          usernameLength: username.length,
          password: '[HIDDEN]',
          passwordLength: password.length
        });

        var isUsernameValid = username.length > 0;
        var isPasswordValid = password.length > 0;

        $('#adminLoginForm button[type="submit"]').prop('disabled', !(isUsernameValid && isPasswordValid));
        console.log('Admin login validation result:', {
          isUsernameValid: isUsernameValid,
          isPasswordValid: isPasswordValid,
          submitDisabled: $('#adminLoginForm button[type="submit"]').prop('disabled')
        });
      }

      $('#adminLoginForm #admin_username, #adminLoginForm #admin_password').on('input blur change keyup paste', function(e) {
        console.log('Admin login input event:', {
          field: $(this).attr('id'),
          eventType: e.type,
          value: $(this).attr('id') === 'admin_username' ? $(this).val() : '[HIDDEN]'
        });
        validateAdminLoginForm();
      });

      $('#adminLoginForm').on('submit', function(e) {
        var username = $('#adminLoginForm #admin_username').val().trim();
        var password = $('#adminLoginForm #admin_password').val().trim();
        console.log('Admin login form submission:', {
          username: username,
          password: '[HIDDEN]'
        });

        if (username === '' || password === '') {
          e.preventDefault();
          alert('Please fill in all fields.');
          console.warn('Admin login submission blocked: Empty fields');
        }
      });

      // Debug modal open
      $('#loginModal').on('show.bs.modal', function() {
        var loginInputs = $('input[id="loginEmail"], input[id="loginPassword"]');
        var allInputs = $('input');
        console.log('Login modal opened, input state:', {
          emailValue: $('#loginForm #loginEmail').val(),
          passwordValue: '[HIDDEN]',
          emailExists: !!$('#loginForm #loginEmail').length,
          passwordExists: !!$('#loginForm #loginPassword').length,
          multipleLoginInputs: loginInputs.length > 2 ? loginInputs.map(function() { return this.outerHTML; }).get() : 'Single inputs',
          totalInputs: allInputs.length + ' inputs found',
          allInputIds: allInputs.map(function() { return $(this).attr('id') || 'no-id'; }).get()
        });
        validateLoginForm();
      });

      $('#registerModal').on('show.bs.modal', function() {
        var passwordInputs = $('input[id="registerPassword"]');
        var allInputs = $('input');
        console.log('Register modal opened, input state:', {
          passwordValue: '[HIDDEN]',
          exists: !!$('#registrationForm #registerPassword').length,
          id: $('#registrationForm #registerPassword').attr('id'),
          multiplePasswordInputs: passwordInputs.length > 1 ? passwordInputs.map(function() { return this.outerHTML; }).get() : 'Single input',
          totalInputs: allInputs.length + ' inputs found',
          allInputIds: allInputs.map(function() { return $(this).attr('id') || 'no-id'; }).get()
        });
      });

      $('#adminLoginModal').on('show.bs.modal', function() {
        var adminInputs = $('input[id="admin_username"], input[id="admin_password"]');
        var allInputs = $('input');
        console.log('Admin login modal opened, input state:', {
          usernameValue: $('#adminLoginForm #admin_username').val(),
          passwordValue: '[HIDDEN]',
          usernameExists: !!$('#adminLoginForm #admin_username').length,
          passwordExists: !!$('#adminLoginForm #admin_password').length,
          multipleAdminInputs: adminInputs.length > 2 ? adminInputs.map(function() { return this.outerHTML; }).get() : 'Single inputs',
          totalInputs: allInputs.length + ' inputs found',
          allInputIds: allInputs.map(function() { return $(this).attr('id') || 'no-id'; }).get()
        });
        validateAdminLoginForm();
      });

      // Prevent modal from clearing inputs
      $('#loginModal, #registerModal, #adminLoginModal, #checkoutModal, #productDetailsModal').on('hidden.bs.modal', function() {
        var formId = $(this).attr('id') === 'loginModal' ? '#loginForm' :
                     $(this).attr('id') === 'registerModal' ? '#registrationForm' :
                     $(this).attr('id') === 'adminLoginModal' ? '#adminLoginForm' :
                     $(this).attr('id') === 'checkoutModal' ? '#checkoutForm' : '#productAddToCartForm';
        $(formId)[0].reset = function() {
          console.log('Form reset prevented for ' + formId);
        };
      });

      // Debug checkout form submission
      $('#checkoutForm').on('submit', function() {
        const transactionCode = $('#transaction-code').val();
        console.log('Checkout form submitted:', { transactionCode });
      });

      // Debug cancel order submission
      $('.btn-delete').on('click', function() {
        const form = $(this).closest('form');
        console.log('Cancel order or remove item clicked:', { action: form.attr('action') });
      });
    });
  </script>
</body>
</html>